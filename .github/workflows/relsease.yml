# .github/workflows/release.yml
name: Release Tempo

on:
  push:
    tags:
      - "v*" # æ¨é€ v0.1.0 è¿™ç±»æ ‡ç­¾æ—¶è§¦å‘

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            target: linux-amd64
            ext: tar.gz
          - os: windows-latest
            target: windows-amd64
            ext: zip
          - os: macos-latest
            target: macos-arm64
            ext: tar.gz
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      # Ubuntu 22.04: ä½¿ç”¨ç¨³å®šçš„ webkit2gtk-4.0
      - name: Install Linux deps
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libgtk-3-dev \
            libwebkit2gtk-4.0-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Frontend install & build
        working-directory: ./frontend
        run: |
          npm ci
          npm run build

      # Linux æ„å»º
      - name: Build (Linux)
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          $(go env GOPATH)/bin/wails build -clean -trimpath -v 2

      # macOS æ„å»ºï¼šä»…åœ¨ macOS è®¾ç½®æœ€ä½ç³»ç»Ÿç‰ˆæœ¬
      - name: Build (macOS)
        if: startsWith(matrix.os, 'macos')
        env:
          CGO_CFLAGS: -mmacosx-version-min=10.15.0
          CGO_LDFLAGS: -mmacosx-version-min=10.15.0
        run: |
          $(go env GOPATH)/bin/wails build -clean -trimpath -v 2

      # Windows æ„å»ºï¼šåµŒå…¥ WebView2ï¼Œæ— éœ€å®‰è£…è¿è¡Œæ—¶
      - name: Build (Windows, embed WebView2)
        if: startsWith(matrix.os, 'windows')
        shell: pwsh
        run: |
          $env:GOBIN = "$(go env GOPATH)\bin"
          $env:PATH += ";$env:GOBIN"
          wails build -clean -trimpath -v 2 -webview2 embed

      - name: Package artifact (Linux/macOS)
        if: startsWith(matrix.os, 'ubuntu') || startsWith(matrix.os, 'macos')
        shell: bash
        run: |
          set -euo pipefail
          APP_NAME="tempo"
          OUT_DIR="dist/${{ matrix.target }}"
          mkdir -p "$OUT_DIR"

          # macOS: åŒæ—¶æ‰“åŒ… .app ä¸äºŒè¿›åˆ¶ï¼ˆè‹¥å­˜åœ¨ï¼‰
          if [[ -d "build/bin/$APP_NAME.app" ]]; then
            cp -R "build/bin/$APP_NAME.app" "$OUT_DIR/"
          fi
          if [[ -f "build/bin/$APP_NAME" ]]; then
            cp "build/bin/$APP_NAME" "$OUT_DIR/"
          fi

          # Linux: å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
          if [[ -f "build/bin/$APP_NAME" ]]; then
            cp "build/bin/$APP_NAME" "$OUT_DIR/" || true
          fi

          tar -czf "dist/${APP_NAME}-${{ matrix.target }}.${{ matrix.ext }}" -C "$OUT_DIR" .

      - name: Package artifact (Windows)
        if: startsWith(matrix.os, 'windows')
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $app = "tempo"
          $out = "dist/windows-amd64"
          New-Item -ItemType Directory -Force -Path $out | Out-Null
          if (!(Test-Path "build\bin\$app.exe")) {
            Write-Error "Executable not found at build\bin\$app.exe"
          }
          Copy-Item "build\bin\$app.exe" $out\
          Compress-Archive -Path "$out\*" -DestinationPath "dist\$app-windows-amd64.zip"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tempo-${{ matrix.target }}
          path: |
            dist/*.${{ matrix.ext }}

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ç”Ÿæˆ changelog éœ€è¦å®Œæ•´å†å²

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Setup Node (for changelog)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # ç”ŸæˆåŸºäº commits çš„ changelog
      - name: Generate changelog
        shell: bash
        run: |
          CURRENT_TAG="${GITHUB_REF_NAME}"
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 "${CURRENT_TAG}^" 2>/dev/null || echo "")

          # ç›´æ¥å†™å…¥æ–‡ä»¶ï¼Œé¿å…å¤šè¡Œè¾“å‡ºé—®é¢˜
          echo "## What's Changed" > release_notes.md
          echo "" >> release_notes.md

          if [ -z "$PREVIOUS_TAG" ]; then
            echo "ğŸ‰ First release of Tempo!" >> release_notes.md
            echo "" >> release_notes.md
            git log --pretty=format:'- %s (%h)' --no-merges --reverse >> release_notes.md
          else
            git log "${PREVIOUS_TAG}..${CURRENT_TAG}" --pretty=format:'- %s (%h)' --no-merges --reverse >> release_notes.md
            echo "" >> release_notes.md
            echo "" >> release_notes.md
            echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREVIOUS_TAG}...${CURRENT_TAG}" >> release_notes.md
          fi

          # æ˜¾ç¤ºç”Ÿæˆçš„å†…å®¹ï¼ˆç”¨äºè°ƒè¯•ï¼‰
          echo "Generated changelog:"
          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: release_notes.md
          files: |
            dist/**/tempo-*.zip
            dist/**/tempo-*.tar.gz
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
